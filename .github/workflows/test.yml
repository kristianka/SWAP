name: Tests
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Type check
        run: bun run typecheck

      - name: Start services with Docker Compose
        run: docker compose up -d

      - name: Wait for RabbitMQ to be ready
        run: |
          echo "Waiting for RabbitMQ to become healthy..."
          timeout 90 bash -c 'until [ "$(docker inspect -f {{.State.Health.Status}} rabbitmq 2>/dev/null)" = "healthy" ]; do 
            echo "RabbitMQ health status: $(docker inspect -f {{.State.Health.Status}} rabbitmq 2>/dev/null || echo pending)"
            sleep 3
          done'
          echo "✓ RabbitMQ is healthy and ready"

      - name: Start all services
        run: bun run start:all > /tmp/services.log 2>&1 &
        env:
          RABBITMQ_URL: amqp://admin:admin@localhost:5672

      - name: Wait for services to be ready
        run: |
          echo "Waiting for services to be healthy..."

          # Wait for Order Service
          timeout 30 bash -c 'until curl -sf http://localhost:3001/health >/dev/null 2>&1; do 
            echo "Waiting for Order Service..."
            sleep 1
          done'
          echo "✓ Order Service is ready"

          # Wait for Inventory Service
          timeout 30 bash -c 'until curl -sf http://localhost:3002/health >/dev/null 2>&1; do 
            echo "Waiting for Inventory Service..."
            sleep 1
          done'
          echo "✓ Inventory Service is ready"

          # Wait for Payment Service
          timeout 30 bash -c 'until curl -sf http://localhost:3003/health >/dev/null 2>&1; do 
            echo "Waiting for Payment Service..."
            sleep 1
          done'
          echo "✓ Payment Service is ready"

      - name: Run tests
        run: bun run test
        env:
          ORDER_SERVICE_URL: http://localhost:3001
          INVENTORY_SERVICE_URL: http://localhost:3002
          PAYMENT_SERVICE_URL: http://localhost:3003

      - name: Show service logs on failure
        if: failure()
        run: |
          echo "=== Services Logs ==="
          cat /tmp/services.log 2>/dev/null || echo "No logs found"
          echo ""
          echo "=== RabbitMQ Logs ==="
          docker compose logs rabbitmq
          echo ""
          echo "=== Docker Containers ==="
          docker ps -a
